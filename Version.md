# 交易資料合併程式修改歷程

## 版本 2.0.0 (日期請自行更新)
### 主要更新
- **新倉時間查找邏輯**：採用序號範圍查找，提升配對準確性。
- **新增序號與UUID**：為《成交紀錄》增加唯一識別碼與排序序號。
- **優化資料處理**：流程化資料清洗、合併與查找。
- **加強錯誤處理與提示**：在檔案讀取、資料配對等環節增加使用者提示。

### 環境需求
1. Python 3.x
2. 相依套件：
   - pandas
   - numpy
   - tqdm

### 執行步驟
1. 環境準備：
   ```bash
   # 建立虛擬環境（選擇性）
   python -m venv venv
   source venv/bin/activate  # MacOS/Linux
   
   # 安裝相依套件
   pip install pandas numpy tqdm
   ```

2. 檔案準備：
   - 確保以下檔案位於同一目錄：
     - merge_trades.py（主程式）
     - 2021-2025 交易明细 工作表1.csv（交易明細檔）
     - 成交紀錄 2021-2025.csv（成交紀錄檔）

3. 執行程式：
   ```bash
   python merge_trades.py
   ```

4. 檢查結果：
   - 輸出檔案：合併交易紀錄.csv
   - 預期筆數：約 1,352 筆
   - 檢查欄位：
     - 成交時間 (平倉時間)
     - 新倉時間 (找到的開倉時間)
     - 商品名稱
     - 口數
     - 新倉價
     - 平倉價
     - 平倉損益淨額
     - UUID

### 程式功能說明
1. **資料清洗與準備**：
   - **載入檔案**：讀取《交易明細》與《成交紀錄》。
   - **清理數值**：移除價格與金額欄位中的千位數逗號、引號及小數點後數字。
   - **轉換型態**：將時間欄位轉為 `datetime`，口數轉為整數。
   - **新增欄位**：對《成交紀錄》進行時間排序，並新增 `UUID` 和 `序號` 欄位。

2. **兩階段合併**：
   - **階段一：平倉交易配對**
     - 將《交易明細》的平倉資訊（成交時間、平倉價、商品名稱）與《成交紀錄》進行比對。
     - 成功配對後，將《成交紀錄》的 `序號` 和 `UUID` 等資訊帶入《交易明細》。
   - **階段二：新倉時間查找**
     - 利用上一步驟得到的 `序號`，在《成交紀錄》中向前查找（預設5筆範圍）。
     - 查找條件：商品名稱相同、倉別為'新倉'、成交價等於新倉價。
     - 找到符合條件的紀錄後，提取其 `成交時間` 作為 `新倉時間`。

3. **結果輸出**：
   - **欄位整理**：篩選最終需要的欄位（成交時間、新倉時間、商品名稱、口數、新倉價、平倉價、平倉損益淨額、UUID）。
   - **移除未配對**：移除未能成功找到 `新倉時間` 的紀錄。
   - **儲存檔案**：將結果儲存為 `合併交易紀錄.csv`。

### 注意事項
1. 資料準備：
   - 確保輸入檔案 (`2021-2025 交易明细 工作表1.csv`, `成交紀錄 2021-2025.csv`) 與 `merge_trades.py` 在同一目錄。
   - 備份您的原始資料檔案。
   - 確保 CSV 檔案中的欄位名稱與規格書一致。

2. 執行過程：
   - 程式執行時會顯示進度條，尤其是在查找新倉時間的步驟。
   - 注意終端機輸出的提示訊息，例如檔案未找到或部分資料未配對。

3. 結果驗證：
   - 檢查 `合併交易紀錄.csv` 是否成功生成。
   - 抽查幾筆資料，確認 `新倉時間` 是否早於 `成交時間`，且價格是否對應。

### 疑難排解
1. 檔案讀取錯誤：
   - **錯誤訊息 `FileNotFoundError`**：請檢查檔案名稱是否完全正確，且檔案是否與腳本在同一目錄。

2. 資料處理問題：
   - **輸出筆數為 0 或遠低於預期**：
     - 檢查 CSV 內的欄位名稱是否與程式碼預期的（`成交時間`, `平倉價`, `新倉價`, `商品名稱` 等）一致。
     - 檢查時間格式或價格格式是否異常，導致無法正確比對。

3. 輸出異常：
   - 檢查磁碟空間
   - 確認寫入權限

### 維護計畫
1. 定期更新：
   - 優化處理效能
   - 改進配對邏輯
   - 擴充錯誤處理

2. 功能擴充：
   - 新增資料驗證
   - 優化記憶體使用
   - 增加彈性設定